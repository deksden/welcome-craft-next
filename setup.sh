#!/bin/bash
#
# setup.sh
# @description Phoenix Project: ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ‘Ğ”
# @version 2.1.0
# @date 2025-06-30
# @updated ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹: local:db:* Ğ¸ test:db:* Ğ´Ğ»Ñ ĞºĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸

# ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ»ÑĞ±Ğ¾Ğ¹ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
set -e

echo "ğŸš€ WelcomeCraft Phoenix Project: ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ..."
echo "================================================================"
echo "ğŸ“‹ Ğ‘ÑƒĞ´ĞµÑ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¾:"
echo "   â€¢ Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ‘Ğ” Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ (Ğ¿Ğ¾Ñ€Ñ‚ 5434)"
echo "   â€¢ Ğ­Ñ„ĞµĞ¼ĞµÑ€Ğ½Ğ°Ñ Ğ‘Ğ” Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ² (ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸)"
echo "   â€¢ Ğ’ÑĞµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ"
echo "================================================================"

# 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ (Docker, pnpm)
echo "1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹..."

if ! command -v docker &> /dev/null
then
    echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: Docker Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Docker Ğ¸ Docker Compose."
    exit 1
fi
echo "   âœ… Docker Ğ½Ğ°Ğ¹Ğ´ĞµĞ½."

if ! command -v pnpm &> /dev/null
then
    echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: pnpm Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ĞµĞ³Ğ¾: npm install -g pnpm"
    exit 1
fi
echo "   âœ… pnpm Ğ½Ğ°Ğ¹Ğ´ĞµĞ½."

# 2. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
echo -e "\n2. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°..."
pnpm install
echo "   âœ… Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹."

# 3. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ Playwright
echo -e "\n3. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ Playwright..."
pnpm exec playwright install --with-deps
echo "   âœ… Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€Ñ‹ Ğ´Ğ»Ñ Playwright ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹."

# 4. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Phoenix Project Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
echo -e "\n4. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Phoenix Project Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ..."

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .env.local Ğ´Ğ»Ñ LOCAL Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
if [ ! -f .env.local ]; then
    echo "   ğŸ“‹ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ .env.local Ğ´Ğ»Ñ LOCAL Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ..."
    
    # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ· Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ°
    cp .env.local.example .env.local
    
    echo "   âœ… Ğ¤Ğ°Ğ¹Ğ» .env.local ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ¸Ğ· .env.local.example."
    echo "   âš ï¸  Ğ’ĞĞ–ĞĞ: Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ AUTH_SECRET, GOOGLE_GENERATIVE_AI_API_KEY Ğ¸ BLOB_READ_WRITE_TOKEN!"
else
    echo "   â„¹ï¸  Ğ¤Ğ°Ğ¹Ğ» .env.local ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚."
fi

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .env.test Ğ´Ğ»Ñ ÑÑ„ĞµĞ¼ĞµÑ€Ğ½Ğ¾Ğ¹ Ğ‘Ğ” Ñ‚ĞµÑÑ‚Ğ¾Ğ²
if [ ! -f .env.test ]; then
    echo "   ğŸ“‹ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ .env.test Ğ´Ğ»Ñ ÑÑ„ĞµĞ¼ĞµÑ€Ğ½Ğ¾Ğ¹ Ğ‘Ğ” Ñ‚ĞµÑÑ‚Ğ¾Ğ²..."
    cat > .env.test << 'EOF'
# Phoenix Project: Ğ­Ñ„ĞµĞ¼ĞµÑ€Ğ½Ğ°Ñ Ğ‘Ğ” Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ² (ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸)
POSTGRES_URL="postgresql://testuser:testpassword@localhost:5433/testdb"
EOF
    echo "   âœ… Ğ¤Ğ°Ğ¹Ğ» .env.test ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ´Ğ»Ñ ÑÑ„ĞµĞ¼ĞµÑ€Ğ½Ğ¾Ğ¹ Ğ‘Ğ” Ñ‚ĞµÑÑ‚Ğ¾Ğ²."
else
    echo "   â„¹ï¸  Ğ¤Ğ°Ğ¹Ğ» .env.test ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚."
fi

echo -e "\n================================================================"
echo "ğŸ‰ Phoenix Project: ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!"
echo "================================================================"
echo ""
echo "ğŸ“‹ Ğ§Ñ‚Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¾:"
echo "   âœ… Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹"
echo "   âœ… Playwright Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ñ‹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹"
echo "   âœ… .env.local ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ´Ğ»Ñ LOCAL Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ"
echo "   âœ… .env.test ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ´Ğ»Ñ ÑÑ„ĞµĞ¼ĞµÑ€Ğ½Ğ¾Ğ¹ Ğ‘Ğ” Ñ‚ĞµÑÑ‚Ğ¾Ğ²"
echo ""
echo "ğŸš€ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸:"
echo "   1. Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ API ĞºĞ»ÑÑ‡Ğ¸ Ğ² .env.local"
echo "   2. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ: pnpm phoenix:dev (Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ½Ğ¸Ğ¼ĞµÑ‚ Ğ‘Ğ” + dev ÑĞµÑ€Ğ²ĞµÑ€)"
echo "   3. Ğ˜Ğ»Ğ¸ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ¿Ğ½Ğ¾:"
echo "      â€¢ pnpm local:db:up     (Ğ¿Ğ¾Ğ´Ğ½ÑÑ‚ÑŒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½ÑƒÑ Ğ‘Ğ”)"
echo "      â€¢ pnpm db:migrate      (Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸)"
echo "      â€¢ pnpm dev             (Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ dev ÑĞµÑ€Ğ²ĞµÑ€)"
echo ""
echo "ğŸ§ª Ğ”Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:"
echo "   â€¢ pnpm test              (Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑÑ„ĞµĞ¼ĞµÑ€Ğ½Ğ¾Ğ¹ Ğ‘Ğ”)"
echo ""
echo "ğŸ“Š ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Phoenix:"
echo "   â€¢ pnpm phoenix:status    (ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ²ÑĞµÑ… ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²)"
echo "   â€¢ pnpm phoenix:health    (health check ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹)"
echo "================================================================"