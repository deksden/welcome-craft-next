#!/bin/bash
#
# setup.sh
# @description –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
# @version 1.0.0
# @date 2025-06-27

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
set -e

echo "üöÄ WelcomeCraft: –ó–∞–ø—É—Å–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
echo "--------------------------------------------------------"

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (Docker, pnpm)
echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."

if ! command -v docker &> /dev/null
then
    echo "‚ùå –û—à–∏–±–∫–∞: Docker –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –∏ Docker Compose."
    exit 1
fi
echo "   ‚úÖ Docker –Ω–∞–π–¥–µ–Ω."

if ! command -v pnpm &> /dev/null
then
    echo "‚ùå –û—à–∏–±–∫–∞: pnpm –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ: npm install -g pnpm"
    exit 1
fi
echo "   ‚úÖ pnpm –Ω–∞–π–¥–µ–Ω."

# 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞
echo -e "\n2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞..."
pnpm install
echo "   ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."

# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ –¥–ª—è Playwright
echo -e "\n3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ –¥–ª—è Playwright..."
pnpm exec playwright install --with-deps
echo "   ‚úÖ –ë—Ä–∞—É–∑–µ—Ä—ã –¥–ª—è Playwright —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."

# 4. –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–æ–≤ –∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤
echo -e "\n4. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ .env..."

# –°–æ–∑–¥–∞–µ–º .env.local –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
if [ ! -f .env.local ]; then
    cp .env.example .env.local
    echo "   ‚úÖ –§–∞–π–ª .env.local —Å–æ–∑–¥–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ –≤–∞—à–∏–º–∏ –∫–ª—é—á–∞–º–∏."
else
    echo "   ‚ÑπÔ∏è  –§–∞–π–ª .env.local —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
fi

# –°–æ–∑–¥–∞–µ–º .env.test –¥–ª—è —Ç–µ—Å—Ç–æ–≤
if [ ! -f .env.test ]; then
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º sed –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è .env.test —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º URL –¥–ª—è Docker
    sed 's/POSTGRES_URL=.*/POSTGRES_URL="postgresql:\/\/testuser:testpassword@localhost:5433\/testdb"/' .env.example > .env.test
    echo "   ‚úÖ –§–∞–π–ª .env.test —Å–æ–∑–¥–∞–Ω —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –¥–ª—è Docker."
else
    echo "   ‚ÑπÔ∏è  –§–∞–π–ª .env.test —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
fi

echo -e "\n--------------------------------------------------------"
echo "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "‚û°Ô∏è  –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∫–æ–º–∞–Ω–¥–æ–π: pnpm dev"
echo "‚û°Ô∏è  –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –∫–æ–º–∞–Ω–¥–æ–π: pnpm test"
echo "--------------------------------------------------------"