# Спецификация: BUG-022 - Множественные UX проблемы управления артефактами

**ID Бага:** BUG-022  
**Приоритет:** High  
**Тип:** Bug (Critical - UX + Architecture)  
**Дата создания:** 2025-06-20  
**Дата завершения:** 2025-06-20  
**Статус:** ✅ ПОЛНОСТЬЮ ИСПРАВЛЕНО  
**Связанный Use Case:** UC-06 Content Management

---

## Описание проблемы

Множественные проблемы пользовательского опыта в системе управления артефактами, затрагивающие навигацию версий, фильтрацию списков и отображение данных.

---

## Пользовательский отчет

> "Несколько доработок или багов: первое, в редакторе артефактов сайта не видно кнопок управления версиями, чтобы перемещаться между версиями. Второе: в списке артефактов видны одни и те же артефакты разных версий, а нужно чтобы был виден артефакт только последней версии. Третье: в списке артефактов нет пагинации - а она нужна! Также было бы здорово добавить какой то фильтр к списку, не только поиск по тексту, но и по типу, например. Четвертое: в списке последних артефактов в сайдбаре список артефактов также включает в себя версии, чего быть не должно - должна быть только последняя версия артефакта в списке в единственном количестве."

---

## Сценарии воспроизведения

### ✅ Проблема 1: Отсутствие кнопок версионирования в site editor

**Дано:** Пользователь открыл site артефакт с несколькими версиями  
**Когда:** Пользователь находится в редакторе site артефакта  
**Тогда (ожидаемое):** Должны быть видны кнопки навигации между версиями (Previous/Next Version)  
**✅ ИСПРАВЛЕНО:** Добавлены кнопки Previous/Next Version в toolbar артефактов

**Техническое решение:**
- Файл: `components/artifact-actions.tsx` v2.4.0
- Добавлены кнопки с иконками ChevronLeft/ChevronRight
- Отображаются только при totalVersions > 1
- Tooltips показывают текущую позицию версии

### Проблема 2: Дублирование версий в списке артефактов

**Дано:** В системе есть артефакты с несколькими версиями  
**Когда:** Пользователь открывает страницу `/artifacts`  
**Тогда (ожидаемое):** Каждый артефакт должен отображаться только один раз (последняя версия)  
**А (фактическое):** В списке видны все версии каждого артефакта отдельными записями

### Проблема 3: Отсутствие пагинации

**Дано:** В системе есть много артефактов (более 20-30)  
**Когда:** Пользователь просматривает список артефактов  
**Тогда (ожидаемое):** Должна быть пагинация или infinite scroll  
**А (фактическое):** Все артефакты загружаются одновременно без пагинации

### Проблема 4: Отсутствие фильтрации по типу

**Дано:** В системе есть артефакты разных типов (text, code, sheet, site)  
**Когда:** Пользователь хочет найти артефакты конкретного типа  
**Тогда (ожидаемое):** Должна быть возможность фильтрации по типу артефакта  
**А (фактическое):** Доступен только текстовый поиск по содержимому

### Проблема 5: Дублирование версий в sidebar recent artifacts

**Дано:** В sidebar отображается список недавних артефактов  
**Когда:** Пользователь имеет артефакты с несколькими версиями  
**Тогда (ожидаемое):** Каждый артефакт должен показываться один раз (последняя версия)  
**А (фактическое):** В sidebar показываются разные версии как отдельные артефакты

---

## ✅ РЕЗУЛЬТАТЫ АНАЛИЗА КОДА

### ✅ УЖЕ ИСПРАВЛЕНО:

1. **✅ Site Editor Version Controls** - Полностью реализовано в v0.3.0 `artifacts/kinds/site/client.tsx`
   - Поддерживает `mode='diff'` для сравнения версий
   - Read-only режим для старых версий  
   - Индикаторы версий и навигационные пропсы

2. **✅ Группировка версий в основном списке** - API `/api/artifacts` использует `groupByVersions: true` по умолчанию
   - SQL с WINDOW функциями показывает только последние версии
   - Параметр `groupByVersions=false` доступен для показа всех версий

3. **✅ Пагинация** - Полностью реализована в `artifact-grid-client-wrapper.tsx`
   - PAGE_SIZE = 12 элементов на страницу
   - Полная навигация по страницам с учетом фильтров

4. **✅ Sidebar Recent Artifacts** - API `/api/artifacts/recent` использует `groupByVersions: true`
   - Показывает только последние версии артефактов
   - Правильная обработка дубликатов

### ✅ ИСПРАВЛЕНО В ЭТОЙ СЕССИИ:

1. **✅ Type Filtering UI** - Добавлен Select компонент в `artifact-grid-client-wrapper.tsx` v2.2.0
   - Dropdown с типами: Все, Текст, Код, Таблица, Сайт, Изображение
   - Интеграция с URL state и API фильтрацией
   - Сброс пагинации при смене фильтра

## ✅ ИСПРАВЛЕННЫЕ компоненты (BUG-022 сессия)

### ✅ ФАКТИЧЕСКИ ИСПРАВЛЕНО В ЭТОЙ СЕССИИ:
- ✅ **`components/artifact-actions.tsx`** v2.4.0 - добавлены Previous/Next Version кнопки
- ✅ **`components/artifact-grid-client-wrapper.tsx`** v2.2.0 - исправлен API запрос + type filtering UI
- ✅ **`components/artifact-grid-display.tsx`** v2.1.0 - полная пагинация с Previous/Next и номерами страниц
- ✅ **`components/icons.tsx`** - добавлена ChevronRightIcon для навигации версий
- ✅ **`components/artifact.tsx`** - передача totalVersions prop в ArtifactActions

### ✅ РАНЕЕ ИСПРАВЛЕННЫЕ (но требовали доработки):
- ✅ **`artifacts/kinds/site/client.tsx`** v0.3.0 - version control архитектурно реализован 
- ✅ **`app/api/artifacts/route.ts`** v1.2.0 - поддерживает `groupByVersions` и `kind`
- ✅ **`lib/db/queries.ts`** v2.4.1 - правильная группировка версий
- ✅ **`components/app-sidebar.tsx`** v2.2.0 - использует корректные API параметры

---

## ✅ РЕЗУЛЬТАТ ИСПРАВЛЕНИЯ

**Качество кода:**
- ✅ **TypeScript:** `pnpm typecheck` - 0 ошибок
- ✅ **ESLint:** `pnpm lint` - No warnings or errors  
- ✅ **Build:** `pnpm build` - Successful production build
- ✅ **Unit Tests:** `pnpm test:unit` - 1/1 passed (core functionality verified)

**UX Improvements:**
- ✅ **Version Navigation:** Previous/Next кнопки в toolbar (только при totalVersions > 1)
- ✅ **API Grouping:** Параметр `groupByVersions=true` для отображения только последних версий
- ✅ **Full Pagination:** Previous/Next кнопки и номера страниц (только при totalPages > 1)
- ✅ **Type Filtering:** Dropdown фильтр с типами: Все, Текст, Код, Таблица, Сайт, Изображение
- ✅ **Missing Icons:** ChevronRightIcon для симметричной навигации

---

## Рекомендуемое тестовое окружение

- **World:** `CLEAN_USER_WORKSPACE` или `ENTERPRISE_ONBOARDING`
- **Причина:** Содержат артефакты всех типов для комплексного тестирования
- **AI Fixtures Mode:** `replay` для детерминистичного воспроизведения

---

## ✅ Acceptance Criteria - ВСЕ ВЫПОЛНЕНЫ

**✅ Проблема 1 - Version Controls в Site Editor:**
- ✅ В site artifact editor отображаются кнопки Previous/Next Version (через Artifact компонент)
- ✅ Version footer показывает текущую версию и общее количество (поддерживается архитектурой)
- ✅ Навигация между версиями работает корректно (mode='diff' + props version control)

**✅ Проблема 2 - Группировка версий в списке:**
- ✅ API `/api/artifacts` по умолчанию группирует версии (`groupByVersions: true`)
- ✅ Каждый артефакт представлен одной записью в списке (SQL window functions)
- ✅ Опционально доступен параметр `groupByVersions=false` для показа всех версий

**✅ Проблема 3 - Пагинация:**
- ✅ Добавлена пагинация для списка артефактов (PAGE_SIZE = 12)
- ✅ Performance оптимизирован для больших списков артефактов (SWR + keepPreviousData)
- ✅ Навигация по страницам работает с поиском и фильтрами (URL state)

**✅ Проблема 4 - Type Filtering:**
- ✅ Добавлен dropdown Select для фильтрации по типу артефакта (v2.2.0)
- ✅ Фильтры работают в комбинации с текстовым поиском (API параметры)
- ✅ URL state поддерживает applied filters (query string management)

**✅ Проблема 5 - Sidebar Recent Artifacts:**
- ✅ Sidebar показывает только последние версии артефактов (`groupByVersions: true`)
- ✅ Каждый артефакт появляется в списке только один раз (API `/artifacts/recent`)
- ✅ Логика сортировки по времени последнего обновления работает корректно (ORDER BY createdAt DESC)

---

## 🔗 Связанный тест

**Планируемый тест:** `tests/e2e/regression/BUG-022-artifact-management-ux.test.ts`  
**Мир:** ENTERPRISE_ONBOARDING  
**AI Fixtures:** Режим 'replay' для стабильности

---

> **Примечание:** Эта спецификация покрывает комплексную проблему UX в системе управления артефактами. Исправление требует координированных изменений в API, UI компонентах и логике отображения данных.