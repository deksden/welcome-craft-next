# Обзор Системы Тестирования WelcomeCraft

Этот документ описывает комплексную систему тестирования проекта WelcomeCraft, её философию, архитектуру и ключевые компоненты.

## 1. Философия Тестирования

Мы придерживаемся гибридного подхода к тестированию, используя лучшие инструменты для каждой задачи:

-   **Vitest:** Для быстрых unit- и integration-тестов, где важна скорость и изоляция.
-   **Playwright:** Для route- (API) и E2E-тестов (UI), где необходимо взаимодействие с реальным браузером и окружением.

Такой подход позволяет нам обеспечить как глубокое покрытие отдельных модулей, так и уверенность в корректной работе системы в целом.

## 2. Четырехуровневая Пирамида Тестирования

Наша стратегия тестирования основана на классической пирамиде, адаптированной под специфику проекта:

1.  **Unit-тесты (Vitest)**
    -   **Расположение:** `tests/unit/`
    -   **Назначение:** Тестирование отдельных функций, классов или модулей в полной изоляции. Вся бизнес-логика, не требующая внешних зависимостей (БД, API), проверяется здесь.
    -   **Особенности:**
        -   Все внешние зависимости (базы данных, сторонние API) **полностью мокируются**.
        -   Максимальная скорость выполнения.
        -   Используют конфигурацию Vitest по умолчанию.

2.  **Integration-тесты (Vitest)**
    -   **Расположение:** `tests/integration/`
    -   **Назначение:** Проверка взаимодействия нескольких модулей или компонентов системы, особенно тех, что работают с базой данных.
    -   **Особенности:**
        -   Используют **реальную, но эфемерную базу данных** (см. "Политика Эфемерной Тестовой БД").
        -   Внешние API (не относящиеся к БД) мокируются.
        -   Специфичная конфигурация Vitest: `vitest.integration.config.ts`.

3.  **Route-тесты (Playwright)**
    -   **Расположение:** `tests/routes/`
    -   **Назначение:** Тестирование API-эндпоинтов на уровне HTTP-запросов. Проверяется корректность обработки запросов, ответов, статусов и бизнес-логики на стороне сервера.
    -   **Особенности:**
        -   Используют Playwright для отправки HTTP-запросов к приложению.
        -   Работают с **реальной эфемерной базой данных**.
        -   Аутентификация через `universalAuthentication` (см. ниже).

4.  **E2E (End-to-End) тесты (Playwright)**
    -   **Расположение:** `tests/e2e/`
    -   **Назначение:** Тестирование полных пользовательских сценариев в реальном браузере. Эмулируют действия пользователя от начала до конца.
    -   **Проекты E2E тестов:**
        -   **`e2e-core`:** Основная функциональность (use-cases/, components/, regression/)
        -   **`e2e-admin`:** Phoenix административная система (phoenix/)
    -   **Особенности:**
        -   Используют Playwright для управления браузером.
        -   Работают с **реальной эфемерной базой данных**.
        -   Применяется система **Изоляции Миров** для параллельного выполнения (см. ниже).
        -   Аутентификация через `universalAuthentication`.

## 3. Политика Эфемерной Тестовой БД

Для обеспечения чистоты и воспроизводимости тестов, WelcomeCraft использует отдельную, эфемерную базу данных для всех автоматизированных тестов (Integration, Route, E2E).

-   **Разделение:**
    -   **Локальная БД для разработки:** Управляется командами `pnpm local:db:*`. Данные в ней постоянны и предназначены для ручной разработки и отладки. Имя контейнера обычно `welcomecraft_postgres_dev`.
    -   **Эфемерная БД для тестов:** Управляется автоматически при запуске `pnpm test` (через `pnpm test:db:up`). Данные в ней создаются и уничтожаются для каждого тестового прогона (хотя сам контейнер может оставаться запущенным). Имя контейнера `welcomecraft_postgres_test`.

-   **Жизненный цикл тестовой БД:**
    -   Перед запуском тестов (`pnpm test`), тестовая БД автоматически подготавливается (запускается контейнер, применяются миграции).
    -   Данные, созданные во время тестов, изолированы и не влияют на локальную БД разработки.
    -   **Важно:** Контейнер тестовой БД (`welcomecraft_postgres_test`) **не останавливается автоматически** после завершения `pnpm test`. Это сделано для ускорения повторных запусков тестов.
    -   Для принудительной остановки контейнера тестовой БД используется команда: `pnpm test:db:down`.
    -   Для полного сброса (удаление volume с данными): `pnpm test:db:reset`.

## 4. Параллельные E2E-тесты с Изоляцией Миров

E2E-тесты могут выполняться параллельно для ускорения общего времени прогона. Для предотвращения конфликтов данных между параллельными тестами реализована система "Изоляции Миров":

-   **Playwright Workers:** Playwright по умолчанию запускает тесты в несколько параллельных воркеров (например, `workers: 3` в `playwright.config.ts`).
-   **`TestWorldAllocator`:** Специальный хелпер (`tests/helpers/test-world-allocator.ts`) назначает каждому воркеру Playwright уникальный идентификатор мира (`worldId`).
-   **`universalAuthentication` и `test-session` Cookie:**
    -   При аутентификации пользователя в E2E-тесте с помощью `universalAuthentication`, `worldId` текущего воркера включается в данные, на основе которых генерируется сессия.
    -   Эта информация передается на бэкенд через специальный `test-session` cookie.
    -   Бэкенд использует `worldId` для сегментации данных в базе данных, обеспечивая полную изоляцию данных между параллельно работающими E2E-тестами. Например, пользователь `ada@test.com` в мире `world-1` не увидит данные пользователя `ada@test.com` из мира `world-2`.

## 5. Унифицированная Аутентификация в Тестах

Для стандартизации и упрощения процесса входа пользователя в систему во время тестов используется единый хелпер:

-   **`universalAuthentication()`:** Находится в `tests/helpers/auth.helper.ts`.
-   **Назначение:** Является **единственным стандартом** для аутентификации пользователей как в E2E-тестах (через `Page`), так и в Route-тестах (через `APIRequestContext`).
-   **Механизм:**
    1.  Вызывает эндпоинт `/api/test/create-user` для создания или получения тестового пользователя в БД (с учетом `worldId` для E2E).
    2.  Вызывает эндпоинт `/api/test/auth-signin` для создания сессии пользователя.
    3.  Для E2E-тестов: использует `page.evaluate` для выполнения `fetch` запроса на стороне браузера, чтобы получить и установить настоящие cookies. Затем осуществляет навигацию на указанную страницу.
    4.  Для Route-тестов: напрямую выполняет API-запросы и сохраняет состояние аутентификации в `APIRequestContext`.

Этот подход гарантирует, что тестовая аутентификация максимально приближена к реальному поведению системы.

## 6. AI Fixtures для Детерминистичного Тестирования

Для обеспечения стабильных и быстрых E2E тестов используется система AI Fixtures Provider v2.0.0 — "lossless" прокси, который записывает и воспроизводит взаимодействия с AI-моделями.

**Подробная документация:** `.memory-bank/testing/AIFixturesProvider.md`

**Ключевые возможности v2.0.0:**
- **Lossless архитектура:** Полное сохранение `GenerateTextResult` объектов без потери метаданных
- **Stream поддержка:** Точное воспроизведение streaming через `stream.tee()` и `streamChunks`
- **Performance boost:** До 54% ускорения AI-интенсивных тестов (UC-02: 46.5s → 21.5s)
- **Четыре режима:** `record`, `replay`, `passthrough`, `record-or-replay`
- **Организация фикстур:** Автоматическая группировка по Use Cases и Worlds
- **Production готовность:** Robust error handling, timeout защита, resource management

## 7. Оптимизация Производительности Тестирования

Для ускорения процесса разработки и CI/CD, используются следующие скрипты:

-   **`smart-build.sh`:** Этот скрипт определяет, нужны ли пересборка Docker-образов и установка зависимостей, основываясь на изменениях в ключевых файлах (например, `package.json`, `pnpm-lock.yaml`, `Dockerfile`). Это позволяет избежать ненужных длительных операций, если код приложения не менялся.
-   **`start-silent-server.sh`:** Запускает сервер приложения в фоновом режиме с подавлением вывода логов в консоль. Это удобно для CI, где логи сервера могут быть избыточными, а также для локальных запусков тестов, когда основной фокус на выводе самих тестов.

Эти инструменты помогают сократить время ожидания и повысить эффективность работы с тестовой системой.

## 8. Структура E2E Тестов и Логика Именования

WelcomeCraft использует двухпроектную структуру E2E тестов для четкого разделения основной функциональности и административной системы:

### E2E Core (`e2e-core`)
**Назначение:** Основная пользовательская функциональность WelcomeCraft
**Включает директории:**
- `tests/e2e/use-cases/` - Пользовательские сценарии (UC-01 до UC-11)
- `tests/e2e/components/` - Тесты отдельных компонентов
- `tests/e2e/regression/` - Регрессионные тесты багов

**Команда запуска:** `playwright test --project=e2e-core`

### E2E Admin (`e2e-admin`)
**Назначение:** Phoenix административная система и enterprise функции
**Включает директории:**
- `tests/e2e/phoenix/` - Admin dashboard, seed export, user management

**Команда запуска:** `playwright test --project=e2e-admin`

### Логика именования
- **`e2e-core`** - "Ядро" основной функциональности для HR пользователей
- **`e2e-admin`** - Административные функции для системных администраторов  
- **`api`** - HTTP API тестирование через Playwright

Это разделение позволяет:
1. Запускать только нужную категорию тестов
2. Распараллеливать тестирование core и admin функций
3. Четко разграничить ответственности между командами разработки
