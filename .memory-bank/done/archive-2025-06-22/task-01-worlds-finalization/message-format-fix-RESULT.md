# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ñ–æ—Ä–º–∞—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π Vercel AI SDK

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–û  
**–î–∞—Ç–∞:** 2025-06-18  
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 60 –º–∏–Ω—É—Ç  

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–í TASK-01 –±—ã–ª–∞ –≤—ã—è–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π:
- **–°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç:** `content: string`, `toolInvocations: Array`
- **–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç AI SDK:** `parts: Array<UIPart>`, `attachments: Array<Attachment>`

–ö–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç, –∞ —Å—Ö–µ–º–∞ –ë–î –æ–∂–∏–¥–∞–ª–∞ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç.

## üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ

### –ò–∑—É—á–µ–Ω–∏–µ Vercel AI SDK —Ç–∏–ø–æ–≤
- ‚úÖ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ç–∏–ø—ã –∏–∑ `@ai-sdk/ui-utils`
- ‚úÖ –ü–æ–Ω—è—Ç–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–µ–∂–¥—É `parts` (—Ç–µ–∫—Å—Ç + tool-invocations) –∏ `attachments` (—Ñ–∞–π–ª—ã)
- ‚úÖ –í—ã—è–≤–ª–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≤ SDK

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–¥–µ:
1. **seed-engine.ts:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ `toolInvocations` –∫–∞–∫ `attachments`
2. **chat/actions.ts:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è artifact IDs
3. **schema.ts:** –ù–∞–ª–∏—á–∏–µ –¥–≤—É—Ö —Å—Ö–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ–∑–¥–∞–≤–∞–ª–æ –ø—É—Ç–∞–Ω–∏—Ü—É

## üõ†Ô∏è –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ seed-engine.ts ‚úÖ
**–ë—ã–ª–æ:**
```typescript
parts: msg.content ? [{ type: 'text', text: msg.content }] : [],
attachments: msg.toolInvocations ? [{ type: 'tool_invocations', data: msg.toolInvocations }] : [],
```

**–°—Ç–∞–ª–æ:**
```typescript
const parts = []
// –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é —á–∞—Å—Ç—å
if (msg.content) {
  parts.push({ type: 'text', text: msg.content })
}
// –î–æ–±–∞–≤–ª—è–µ–º tool invocations –∫–∞–∫ —á–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (–ù–ï –∫–∞–∫ attachments!)
if (msg.toolInvocations && Array.isArray(msg.toolInvocations)) {
  msg.toolInvocations.forEach((toolInvocation: any) => {
    parts.push({
      type: 'tool-invocation',
      toolInvocation: toolInvocation
    })
  })
}
// –§–∞–π–ª–æ–≤—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è attachments
attachments: msg.attachments || []
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ chat/actions.ts ‚úÖ
**–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞:**
```typescript
// –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ AI SDK Message_v2
if (part && typeof part === 'object' && (part as any).type === 'tool-invocation') {
  const toolInvocation = (part as any).toolInvocation
  // ... –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ artifactId
}
// –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
else if (part && typeof part === 'object' && 'toolInvocations' in part) {
  // ... —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞
}
```

### 3. –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π —Å—Ö–µ–º—ã ‚úÖ
- ‚úÖ –£–¥–∞–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `messageDeprecated` –∏–∑ schema.ts
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `0005_remove_legacy_message.sql`
- ‚úÖ –£–¥–∞–ª–µ–Ω —Ç–∏–ø `MessageDeprecated` –∏–∑ types.ts
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã meta —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç AI SDK Message_v2:
```typescript
interface DBMessage {
  parts: Array<{
    type: 'text';
    text: string;
  } | {
    type: 'tool-invocation';
    toolInvocation: ToolInvocation;
  }>;
  attachments: Array<{
    name?: string;
    contentType?: string;
    url: string;
  }>;
}
```

### –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤:
1. **Production –∫–æ–¥:** `msg.parts ?? [{ type: 'text', text: msg.content }]`
2. **Seed-engine:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è `toolInvocations` –≤ `parts`
3. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ:
- **–ï–¥–∏–Ω–∞—è —Å—Ö–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:** –¢–æ–ª—å–∫–æ `Message_v2` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
- **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ tool invocations:** –ö–∞–∫ —á–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è, –∞ –Ω–µ attachments
- **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∏–∫—Å—Ç—É—Ä:** –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç ‚Üí –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
- **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** Production –∫–æ–¥ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞
- **–ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –£–¥–∞–ª–µ–Ω–∞ –ø—É—Ç–∞–Ω–∏—Ü–∞ —Å –¥–≤—É–º—è —Å—Ö–µ–º–∞–º–∏

### ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
- **Seed Engine:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–∏–∫—Å—Ç—É—Ä—ã –≤ –Ω–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
- **Production API:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î
- **Extraction –ª–æ–≥–∏–∫–∞:** –ò–∑–≤–ª–µ–∫–∞–µ—Ç artifact IDs –∏–∑ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
- **–ë–î –º–∏–≥—Ä–∞—Ü–∏–∏:** –ì–æ—Ç–æ–≤—ã –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- `tests/helpers/seed-engine.ts` - ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞
- `app/app/(main)/chat/actions.ts` - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
- `lib/db/schema.ts` - ‚úÖ –£–¥–∞–ª–µ–Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Å—Ö–µ–º–∞
- `lib/db/types.ts` - ‚úÖ –£–¥–∞–ª–µ–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ç–∏–ø

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î:
- `lib/db/migrations/0005_remove_legacy_message.sql` - ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π —Ç–∞–±–ª–∏—Ü—ã
- `lib/db/migrations/meta/0005_snapshot.json` - ‚úÖ Snapshot –Ω–æ–≤–æ–π —Å—Ö–µ–º—ã
- `lib/db/migrations/meta/_journal.json` - ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –∂—É—Ä–Ω–∞–ª

## üéØ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É—Ä–æ–∫–∏:
1. **Tool invocations ‚â† Attachments:** Tool invocations —ç—Ç–æ —á–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è, –∞ –Ω–µ —Ñ–∞–π–ª–æ–≤—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è
2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** AI SDK –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç —á–µ—Ä–µ–∑ fallback
3. **–ï–¥–∏–Ω–∞—è —Å—Ö–µ–º–∞ –ª—É—á—à–µ:** –î–≤–µ —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞—é—Ç –ø—É—Ç–∞–Ω–∏—Ü—É –∏ –æ—à–∏–±–∫–∏

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:
- **–ò–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞:** `content` ‚Üí `[{ type: 'text', text: content }]`
- **Tool invocations:** –ö–∞–∂–¥—ã–π `toolInvocation` ‚Üí `{ type: 'tool-invocation', toolInvocation }`
- **Attachments:** –¢–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è, –ù–ï tool invocations

---

**‚úÖ –ü–†–û–ë–õ–ï–ú–ê –§–û–†–ú–ê–¢–ê –°–û–û–ë–©–ï–ù–ò–ô –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–ê**

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—É—é —Å—Ö–µ–º—É `Message_v2` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º AI SDK. –í—Å—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –ø—É—Ç–∞–Ω–∏—Ü–∞ —Å –¥–≤—É–º—è —Å—Ö–µ–º–∞–º–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞.

// END OF: message-format-fix-RESULT