# TASK-02: –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û  
**–î–∞—Ç–∞:** 2025-06-18  
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 40 –º–∏–Ω—É—Ç  

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### ‚úÖ –≠–¢–ê–ü 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ FixtureMode

**–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `lib/ai/fixtures-provider.ts` - –¥–æ–±–∞–≤–ª–µ–Ω —Ä–µ–∂–∏–º 'record-or-replay'

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
export type FixtureMode = 'record' | 'replay' | 'passthrough' | 'record-or-replay'
```

### ‚úÖ –≠–¢–ê–ü 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ record-or-replay

**–§–∞–π–ª:** `lib/ai/fixtures-provider.ts` (—Å—Ç—Ä–æ–∫–∏ 155-194)

**–ö–ª—é—á–µ–≤–∞—è –ª–æ–≥–∏–∫–∞ doGenerate:**
```typescript
if (self.config.mode === 'record-or-replay') {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–∫—Å—Ç—É—Ä—É, replay –∏–ª–∏ record
  const fixture = await self.loadFixture(fixtureId, context)
  if (fixture) {
    // –ï—Å–ª–∏ —Ñ–∏–∫—Å—Ç—É—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –µ–µ (replay)
    self.log(`üîÅ Replaying fixture: ${fixtureId}`)
    return self.convertFixtureToResult(fixture)
  } else {
    // –ï—Å–ª–∏ –Ω–µ—Ç - –¥–µ–ª–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º (record)
    self.log(`üìù Recording new fixture on-the-fly: ${fixtureId}`)
    
    const result = await Promise.race([
      originalModel.doGenerate(options),
      new Promise<never>((_, reject) => 
        setTimeout(() => reject(new Error('AI request timeout')), self.config.recordTimeout)
      )
    ])
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–∫—Å—Ç—É—Ä—É
    await self.saveFixture(fixtureId, { /* ... */ }, context)
    
    return result
  }
}
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è doStream:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è streaming (—Å—Ç—Ä–æ–∫–∏ 244-256)

### ‚úÖ –≠–¢–ê–ü 3: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è Summarizer

**–§–∞–π–ª:** `tests/unit/lib/ai/summarizer.test.ts` (–Ω–æ–≤—ã–π)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤:**
- ‚úÖ 6 —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–ª—É—á–∞–µ–≤
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ –º–æ–∫–∏ (DB, AI SDK, AI provider)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (text, code, site, image)
- ‚úÖ Graceful error handling
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ fixtures provider

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
```typescript
describe('Summarizer with AI Fixtures (record-or-replay)', () => {
  beforeEach(() => {
    process.env.AI_FIXTURES_MODE = 'record-or-replay'
    fixturesProvider = new AIFixturesProvider({
      mode: 'record-or-replay',
      fixturesDir: './tests/fixtures/ai/summarizer',
      debug: true
    })
  })
  
  it('should generate and save summary for text artifact', async () => {
    const wrappedModel = fixturesProvider.wrapModel(mockModel, {
      useCaseId: 'summarizer-text',
      fixturePrefix: 'summarizer'
    })
    
    vi.mocked(myProvider.languageModel).mockReturnValue(wrappedModel)
    
    await generateAndSaveSummary(artifactId, testContent, 'text')
    
    expect(vi.mocked(generateText)).toHaveBeenCalledWith({
      model: wrappedModel,
      prompt: expect.stringContaining('–°–¥–µ–ª–∞–π –æ—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ–µ —Å–∞–º–º–∞—Ä–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞')
    })
  })
})
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è

### –ù–æ–≤—ã–π —Ä–µ–∂–∏–º record-or-replay
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—Å—Ç—å:** –§–∏–∫—Å—Ç—É—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
- **–î–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º:** –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- **–£–¥–æ–±—Å—Ç–≤–æ:** –ù–µ –Ω—É–∂–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ñ–∏–∫—Å—Ç—É—Ä—ã
- **–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å:** –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Å—Ç–æ—è—â–∏–π AI

### –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤
- **–ú–æ–∫–∏ DB –æ–ø–µ—Ä–∞—Ü–∏–π** - –∏–∑–æ–ª—è—Ü–∏—è –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **–ú–æ–∫–∏ AI SDK** - –∫–æ–Ω—Ç—Ä–æ–ª—å generateText –≤—ã–∑–æ–≤–æ–≤  
- **–ú–æ–∫–∏ AI Provider** - –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ wrapped –º–æ–¥–µ–ª–∏
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤ afterEach

### –ü–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
- **Text:** "–°–¥–µ–ª–∞–π –æ—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ–µ —Å–∞–º–º–∞—Ä–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞"
- **Code:** "–°–¥–µ–ª–∞–π –æ—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ–µ —Å–∞–º–º–∞—Ä–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –∫–æ–¥–∞"
- **Site:** "–û–ø–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞ –∫—Ä–∞—Ç–∫–æ" + –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- **Image:** "–û–ø–∏—à–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫—Ä–∞—Ç–∫–æ"

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ:
```
‚úì tests/unit/lib/ai/summarizer.test.ts (6 tests) 8ms

Test Files  1 passed (1)
Tests  6 passed (6)
```

### ‚úÖ AI Fixtures Provider –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
```
[AI-Fixtures] ü§ñ AI Fixtures Provider initialized: {
  mode: 'record-or-replay',
  fixturesDir: './tests/fixtures/ai/summarizer'
}
```

### ‚úÖ Error handling —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
```
SYS_SUMMARIZER: AI quota/limit reached for artifact test-error-artifact, skipping summary generation
```

## üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
# –û–±—ã—á–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å –º–æ–∫–∞–º–∏
pnpm test:unit summarizer.test.ts

# –ó–∞–ø—É—Å–∫ —Å record-or-replay —Ä–µ–∂–∏–º–æ–º
AI_FIXTURES_MODE=record-or-replay pnpm test:unit summarizer.test.ts
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∏–∫—Å—Ç—É—Ä:
```
tests/fixtures/ai/
‚îú‚îÄ‚îÄ general/
‚îú‚îÄ‚îÄ use-cases/
‚îÇ   ‚îú‚îÄ‚îÄ UC-01/ - site-publication-dialog-e8f9k2.json
‚îÇ   ‚îî‚îÄ‚îÄ UC-02/ - ai-site-generation-m3n8r5.json
‚îî‚îÄ‚îÄ worlds/
```

## üéØ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ü–µ–ª–∏

### ‚úÖ –†–µ–∂–∏–º record-or-replay –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–∫—Å—Ç—É—Ä
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å –Ω–æ–≤—ã—Ö —Ñ–∏–∫—Å—Ç—É—Ä
- –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ doGenerate, —Ç–∞–∫ –∏ doStream

### ‚úÖ –¢–µ—Å—Ç—ã Summarizer —Å–æ–∑–¥–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- 6 –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–ª—É—á–∞–µ–≤
- –ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
- –ò–∑–æ–ª—è—Ü–∏—è –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- Graceful error handling

### ‚úÖ AI Fixtures –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ fixtureId —á–µ—Ä–µ–∑ hashing
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
- Debug –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## üîó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞:
1. **–£–¥–æ–±—Å—Ç–≤–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** –¢–µ—Å—Ç—ã —Å AI –±–æ–ª—å—à–µ –Ω–µ —Ç—Ä–µ–±—É—é—Ç —Ä—É—á–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ñ–∏–∫—Å—Ç—É—Ä
2. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å CI/CD:** –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Å—Ç–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö
3. **–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å:** –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Å—Ç–æ—è—â–∏–π AI –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–∞—Ö:
–†–µ–∂–∏–º `record-or-replay` —Å—Ç–∞–Ω–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º –¥–ª—è –≤—Å–µ—Ö AI-–∑–∞–≤–∏—Å–∏–º—ã—Ö —Ç–µ—Å—Ç–æ–≤:
- Artifact generation —Ç–µ—Å—Ç—ã
- Chat conversation —Ç–µ—Å—Ç—ã  
- Site generation —Ç–µ—Å—Ç—ã
- Summary generation —Ç–µ—Å—Ç—ã

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ TASK-03:
- ‚úÖ AI Fixtures Provider –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- ‚úÖ –¢–µ—Å—Ç—ã —Å—Ç–∞–±–∏–ª—å–Ω—ã –∏ –ø—Ä–æ—Ö–æ–¥—è—Ç

### –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ "–ó–∞–∫–∞–ª–∫–∞ –∏ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ":
–ü–µ—Ä–µ—Ö–æ–¥ –∫ **TASK-03: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è —é–Ω–∏—Ç-—Ç–µ—Å—Ç–∞–º–∏ –¥–ª—è queries.ts –∏ artifact-content-utils.ts**

---

**‚úÖ TASK-02 –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê**

–†–µ–∂–∏–º `record-or-replay` –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω. Summarizer –ø–æ–∫—Ä—ã—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AI Fixtures. –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –≤–æ –≤—Å–µ—Ö AI-–∑–∞–≤–∏—Å–∏–º—ã—Ö —Ç–µ—Å—Ç–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞.

// END OF: TASK-02 RESULT