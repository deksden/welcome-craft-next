## üé≠ Playwright Testing Setup

**–í–µ—Ä—Å–∏—è:** 3.0.0  
**–î–∞—Ç–∞:** 2025-06-15
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–ê–ï–¢

### HISTORY:
* v3.0.0 (2025-06-15): **üéâ –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–´ –í–°–ï –ü–†–û–ë–õ–ï–ú–´!** –°–æ–∑–¥–∞–Ω custom test auth middleware, –æ–±—Ö–æ–¥ Auth.js v5, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ UUID –ø—Ä–æ–±–ª–µ–º–∞ –¥–ª—è PostgreSQL.
* v2.0.0 (2025-06-14): **–†–ï–®–ï–ù–ê –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê —Å –ø–æ—Ä—Ç–∞–º–∏!** Async config Playwright'–∞ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, –∫–∞–∂–¥—ã–π —Ä–∞–∑ –≤—ã–±–∏—Ä–∞—è –Ω–æ–≤—ã–π –ø–æ—Ä—Ç. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Ä–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è PLAYWRIGHT_PORT.
* v1.1.0 (2025-06-13): –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–æ—Ä—Ç–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.
* v1.0.0 (2025-06-12): –ù–∞—á–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è.

–í —ç—Ç–æ–º —Ñ–∞–π–ª–µ –æ–ø–∏—Å–∞–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Playwright –¥–ª—è API-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ (–ø—Ä–æ–µ–∫—Ç–∞ `routes`).

### ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ú—É–ª—å—Ç–∏-–¥–æ–º–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–ù–ï–û–ß–ï–í–ò–î–ù–û –î–õ–Ø AI:** –ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —Å–ª–æ–∂–Ω—É—é –º—É–ª—å—Ç–∏-–¥–æ–º–µ–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

#### Development –¥–æ–º–µ–Ω—ã:
- **–û—Å–Ω–æ–≤–Ω–æ–π:** `localhost:3000` ‚Üí —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –∏–∑ `/site` (–ø—É–±–ª–∏—á–Ω—ã–π)
- **–ê–¥–º–∏–Ω–∫–∞:** `app.localhost:3000` ‚Üí —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –∏–∑ `/app` (—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π)
- **API routes:** –ì–ª–æ–±–∞–ª—å–Ω—ã–µ! –î–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ –ª—é–±–æ–º –¥–æ–º–µ–Ω–µ

#### ‚úÖ –ü–†–û–ë–õ–ï–ú–ê –° –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ï–ô –†–ï–®–ï–ù–ê!

**–ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω custom test authentication middleware, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ö–æ–¥–∏—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ Auth.js v5 –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ.

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è:**

1. **–¢–µ—Å—Ç–æ–≤—ã–π auth endpoint:** `/api/test/auth-signin/route.ts`
   - –°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ–π JSON session cookie `test-session`
   - –û–±—Ö–æ–¥–∏—Ç Auth.js JWT —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
   - –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ test environment
   - **–í–ê–ñ–ù–û:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π UUID –¥–ª—è PostgreSQL: `'00000000-0000-0000-0000-000000000000'`

2. **Custom auth middleware:** `lib/test-auth.ts`
   - –§—É–Ω–∫—Ü–∏—è `getTestSession()` —á–∏—Ç–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ cookies
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç test environment –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º—É—é —Å Auth.js —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–µ—Å—Å–∏–∏

3. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ API routes:**
   - –í—Å–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ endpoints –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç dual auth:
   ```typescript
   let session = await auth()
   if (!session?.user) {
     session = await getTestSession()
   }
   ```

4. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ fixtures:** `tests/api-fixtures.ts`
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç `/api/test/auth-signin` –≤–º–µ—Å—Ç–æ browser login
   - –ü–µ—Ä–µ–¥–∞—é—Ç `test-session` cookie –≤ API requests
   - –ë—ã—Å—Ç—Ä–µ–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ

**üî• –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï - UUID –¥–ª—è PostgreSQL:**
- PostgreSQL —Ç—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π UUID —Ñ–æ—Ä–º–∞—Ç –¥–ª—è user_id –∫–æ–ª–æ–Ω–∫–∏
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å `"test-user-id"` –Ω–∞ `"00000000-0000-0000-0000-000000000000"`
- –≠—Ç–æ —Ä–µ—à–∏–ª–æ –≤—Å–µ 400 –æ—à–∏–±–∫–∏ –≤ API —Ç–µ—Å—Ç–∞—Ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ API —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ (–≤—Å–µ 9/9 artifacts —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏)
- ‚úÖ –í—Å–µ authentication endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ù–µ—Ç hanging processes
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã —á–µ—Ä–µ–∑ `PLAYWRIGHT_PORT`
- ‚úÖ PostgreSQL –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π UUID —Ñ–æ—Ä–º–∞—Ç

### üìã **–ò–¢–û–ì –ê–ù–ê–õ–ò–ó–ê - –í–°–Å –£–ü–†–û–©–ï–ù–û –ù–ê –û–î–ò–ù –î–û–ú–ï–ù:**

1. ‚úÖ **–ü–æ—Ä—Ç—å—è –†–ï–®–ï–ù–´** - `PLAYWRIGHT_PORT` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
2. ‚úÖ **–û–¥–∏–Ω –¥–æ–º–µ–Ω –¥–ª—è –≤—Å–µ–≥–æ** - `app.localhost:PORT` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ª–æ–≥–∏–Ω–∞ –∏ API
3. ‚úÖ **Auth.js v5 API** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è `auth()` —Ñ—É–Ω–∫—Ü–∏—è –≤ endpoints
4. ‚ùå **–ù–û session token –ù–ï –°–û–ó–î–ê–ï–¢–°–Ø** - Auth.js –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `authjs.session-token`

### üéØ **–§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï - –ö–û–ú–ë–ò–ù–ò–†–û–í–ê–ù–ù–´–ô –ü–û–î–•–û–î:**

#### **API —Ç–µ—Å—Ç—ã (routes):**
- ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π JWT endpoint `/api/test/auth-signin` 
- ‚úÖ –û–±—Ö–æ–¥–∏—Ç Auth.js v5 —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
- ‚úÖ –ü—Ä—è–º–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ session cookies

#### **E2E —Ç–µ—Å—Ç—ã:**
- ‚úÖ –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (admin, user, manager)
- ‚úÖ Storage State –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ Global setup –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
- ‚úÖ –£–¥–æ–±–Ω—ã–µ fixtures: `adminPage`, `userPage`, `authenticatedPage(role)`

#### **–ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞:**
- `pnpm test:routes` - API —Ç–µ—Å—Ç—ã
- `pnpm test:e2e` - E2E —Ç–µ—Å—Ç—ã  
- `pnpm test:e2e:admin` - —Ç–æ–ª—å–∫–æ admin —Ç–µ—Å—Ç—ã
- `pnpm test:e2e:user` - —Ç–æ–ª—å–∫–æ user —Ç–µ—Å—Ç—ã
- `pnpm test:setup` - –ø–µ—Ä–µ–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### üîß –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –° –ü–û–†–¢–ê–ú–ò (v2.0.0)

**–ü—Ä–æ–±–ª–µ–º–∞:** Async –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Playwright'–∞ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, –∫–∞–∂–¥—ã–π —Ä–∞–∑ –≤—ã–±–∏—Ä–∞—è –Ω–æ–≤—ã–π —Å–≤–æ–±–æ–¥–Ω—ã–π –ø–æ—Ä—Ç:
- –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–ª—Å—è –Ω–∞ –ø–æ—Ä—Ç—É 3000
- –ù–æ baseURL –¥–ª—è —Ç–µ—Å—Ç–æ–≤ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª—Å—è –Ω–∞ –ø–æ—Ä—Ç 3001
- –†–µ–∑—É–ª—å—Ç–∞—Ç: `connect ECONNREFUSED ::1:3001`

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `PLAYWRIGHT_PORT` –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏:

```typescript
// playwright.config.ts
export default (async () => {
  // –ï—Å–ª–∏ PLAYWRIGHT_PORT —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
  // –ò–Ω–∞—á–µ –∏—â–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–π –ø–æ—Ä—Ç –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
  const port = await getPort()
  
  return defineConfig({
    webServer: {
      command: `pnpm dev --port ${port}`,
      url: `http://localhost:${port}/api/ping`,
    },
    projects: [
      { name: 'e2e', use: { baseURL: `http://app.localhost:${port}` } },
      { name: 'routes', use: { baseURL: `http://localhost:${port}` } }
    ]
  })
})()

async function getPort(): Promise<number> {
  if (process.env.PLAYWRIGHT_PORT) {
    return parseInt(process.env.PLAYWRIGHT_PORT, 10)
  }
  
  const port = await findAvailablePort(3000)
  process.env.PLAYWRIGHT_PORT = port.toString() // ‚úÖ –ö–ª—é—á —Ä–µ—à–µ–Ω–∏—è!
  return port
}
```

### üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞

1.  **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã:**
    -   ‚úÖ –û–¥–∏–Ω –ø–æ—Ä—Ç –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (webServer + baseURL)
    -   ‚úÖ –ù–µ—Ç –≤–∏—Å—è—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ä—Ç–∞—Ö
    -   ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `PLAYWRIGHT_PORT` —É–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–æ–¥—Ö–æ–¥

2.  **–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞:**
    -   `webServer.url` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ `/api/ping`, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–∫–ª—é—á–µ–Ω –∏–∑ middleware –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ.

3.  **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Worker'–∞–º–∏:**
    -   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ `1` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ Redis.

### 1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–ª—è –≤—Å–µ—Ö API-–∑–∞–ø—Ä–æ—Å–æ–≤ Playwright –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–æ–∫:
```http
X-Test-Environment: playwright
```
–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤ –∫–æ–¥–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤:
- –≤—ã–±–∏—Ä–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π endpoint `/api/test/create-user` –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π;
- –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å stub –≤ –º–∞—Ä—à—Ä—É—Ç–µ `/api/files/upload` (–≤–æ–∑–≤—Ä–∞—Ç —Ñ–∏–∫—Ç–∏–≤–Ω–æ–≥–æ uploadUrl –∏ —Ç–æ–∫–µ–Ω–∞);

### 2. Stub `/api/files/upload`

–í —Ä–µ–∂–∏–º–µ Playwright –∫–æ–¥ –º–∞—Ä—à—Ä—É—Ç–∞ `/api/files/upload` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Test-Environment` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ Vercel Blob:
```ts
if (request.headers.get('X-Test-Environment') === 'playwright') {
  return NextResponse.json({
    uploadUrl: `${request.url}/test-upload`,
    token: JSON.stringify({ userId: session.user.id }),
  });
}
```

### 3. –ò—Ç–æ–≥

–° –ø–æ–º–æ—â—å—é —ç—Ç–æ–≥–æ setup Playwright-—Ç–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ, –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–æ—Ä—Ç–æ–≤ –∏ —Å –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –∏—Ö –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–º–∏.
